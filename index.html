<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Reclutador de M√©dicos Especialistas ‚Äì IMSS BCS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --imss-green: #00695c;
      --imss-green-dark: #004d40;
      --imss-green-light: #e0f2f1;
      --accent-green: #26a69a;
      --error-red: #e53935;
      --warning-amber: #ffb300;
      --text-main: #263238;
      --text-muted: #607d8b;
      --bg-main: #f5f7f8;
      --border-soft: #cfd8dc;
      --card-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      --radius-lg: 12px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: var(--bg-main);
      color: var(--text-main);
    }

    h1, h2, h3, h4 {
      margin: 0;
      font-weight: 600;
    }

    button {
      cursor: pointer;
      border: none;
      font-family: inherit;
    }

    a { color: var(--imss-green-dark); }

    .app-header {
      background: linear-gradient(135deg, var(--imss-green-dark), var(--imss-green));
      color: white;
      padding: 16px 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.18);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .app-header-title { font-size: 1.3rem; }
    .app-header-subtitle { font-size: 0.9rem; opacity: 0.9; margin-top: 4px; }

    .app-main {
      display: flex;
      flex-direction: row;
      gap: 16px;
      padding: 16px;
      max-width: 1240px;
      margin: 0 auto;
    }

    .search-section {
      flex: 2;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-width: 0;
    }

    .side-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-width: 260px;
    }

    .card {
      background-color: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--card-shadow);
      padding: 14px 16px;
      border: 1px solid #e0e0e0;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 8px;
    }

    .card-title { font-size: 1rem; font-weight: 600; }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.72rem;
      font-weight: 500;
      border: 1px solid transparent;
    }

    .badge-pending {
      background-color: #eceff1;
      color: var(--text-muted);
      border-color: #cfd8dc;
    }
    .badge-interested {
      background-color: #e8f5e9;
      color: #2e7d32;
      border-color: #66bb6a;
    }
    .badge-rejected {
      background-color: #ffebee;
      color: #c62828;
      border-color: #ef5350;
    }
    .badge-followup {
      background-color: #fff8e1;
      color: #ef6c00;
      border-color: #ffb300;
    }

    .search-form {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      align-items: flex-end;
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .form-field label {
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-muted);
    }

    .form-field input,
    .form-field select,
    .form-field textarea {
      padding: 8px 9px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      font: inherit;
      min-height: 34px;
      resize: vertical;
    }

    .form-field input:focus,
    .form-field select:focus,
    .form-field textarea:focus {
      outline: 2px solid var(--accent-green);
      outline-offset: 1px;
      border-color: var(--accent-green);
    }

    .search-button {
      padding: 9px 12px;
      background-color: var(--imss-green);
      color: white;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.95rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border: 1px solid var(--imss-green-dark);
    }

    .search-button:hover { background-color: var(--imss-green-dark); }
    .search-button:disabled { opacity: 0.7; cursor: default; }
    .search-button span.icon { font-size: 1.1rem; }

    .status-message {
      font-size: 0.85rem;
      color: var(--text-muted);
      min-height: 18px;
    }
    .status-message.error { color: var(--error-red); }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
      margin-bottom: 6px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .results-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 4px;
      max-height: 60vh;
      overflow-y: auto;
      padding-right: 4px;
    }

    .doctor-card {
      border-left: 4px solid var(--accent-green);
      position: relative;
      transition: background-color 0.15s ease, border-color 0.15s ease, transform 0.1s ease;
    }

    .doctor-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }

    .doctor-card--contacted {
      background-color: var(--imss-green-light);
      border-left-color: var(--imss-green-dark);
    }

    .doctor-meta {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.4fr);
      gap: 8px;
      font-size: 0.83rem;
      margin-bottom: 6px;
    }

    .doctor-meta-item { color: var(--text-muted); }
    .doctor-meta-label { font-weight: 500; color: var(--text-main); }

    .doctor-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
      align-items: center;
    }

    .btn-ghost {
      padding: 5px 9px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background-color: #fafafa;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-ghost:hover { background-color: #eceff1; }
    .btn-ghost.primary {
      border-color: var(--accent-green);
      color: var(--imss-green-dark);
    }

    .doctor-followup {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
      gap: 8px;
      margin-top: 4px;
      align-items: flex-start;
    }

    .doctor-followup textarea {
      min-height: 42px;
      font-size: 0.8rem;
    }

    .doctor-followup select {
      font-size: 0.8rem;
      min-height: 34px;
    }

    .doctor-select-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-top: 6px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .side-section-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--imss-green-dark);
    }

    .selection-summary {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .selected-list {
      max-height: 120px;
      overflow-y: auto;
      font-size: 0.8rem;
      padding-left: 0;
      margin: 0;
      list-style: none;
      border-radius: 8px;
      background-color: #fafafa;
      border: 1px dashed var(--border-soft);
    }

    .selected-list li {
      padding: 4px 8px;
      border-bottom: 1px solid #eceff1;
    }
    .selected-list li:last-child { border-bottom: none; }

    .panel-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .btn-outline {
      background-color: white;
      border-radius: 999px;
      border: 1px solid var(--imss-green);
      color: var(--imss-green-dark);
      padding: 6px 9px;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-outline:hover { background-color: var(--imss-green-light); }

    .panel-subtitle {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .invitation-textarea {
      width: 100%;
      min-height: 120px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      padding: 8px 9px;
      font: inherit;
      font-size: 0.8rem;
      resize: vertical;
    }

    .invitation-textarea:focus {
      outline: 2px solid var(--accent-green);
      outline-offset: 1px;
      border-color: var(--accent-green);
    }

    .contacted-list {
      max-height: 220px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 4px;
    }

    .contacted-item {
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background-color: #fafafa;
      padding: 7px 8px;
      font-size: 0.78rem;
    }

    .contacted-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .contacted-name { font-weight: 600; color: var(--text-main); }

    .contacted-meta {
      color: var(--text-muted);
      font-size: 0.76rem;
      margin-bottom: 4px;
    }

    .contacted-controls {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.1fr);
      gap: 6px;
      align-items: flex-start;
    }

    .contacted-controls textarea {
      min-height: 40px;
      font-size: 0.78rem;
    }

    .contacted-controls select {
      font-size: 0.78rem;
      min-height: 32px;
    }

    .app-footer {
      max-width: 1240px;
      margin: 0 auto 12px;
      padding: 0 16px;
    }

    .app-footer-inner {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-align: left;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 2px 7px;
      border-radius: 999px;
      background-color: #eceff1;
      font-size: 0.75rem;
      color: var(--text-muted);
      gap: 4px;
    }

    .chip-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: currentColor;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.78rem;
    }

    .doctor-card.status-pendiente { border-left-color: var(--accent-green); }
    .doctor-card.status-interesado { border-left-color: #43a047; }
    .doctor-card.status-rechazo { border-left-color: #e53935; }
    .doctor-card.status-seguimiento { border-left-color: #ffb300; }

    @media (max-width: 960px) {
      .app-main { flex-direction: column; }
      .side-panel { min-width: 0; }
      .results-list { max-height: none; }
    }

    @media (max-width: 720px) {
      .search-form { grid-template-columns: minmax(0, 1fr); }
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div>
      <div class="app-header-title">
        Reclutador de M√©dicos Especialistas ‚Äì IMSS BCS
      </div>
      <div class="app-header-subtitle">
        Herramienta interna para localizar, contactar y dar seguimiento a m√©dicos especialistas usando informaci√≥n p√∫blica.
      </div>
    </div>
  </header>

  <main class="app-main">
    <section class="search-section">
      <div class="card">
        <form id="searchForm" class="search-form">
          <div class="form-field">
            <label for="specialtyInput">Especialidad</label>
            <input id="specialtyInput" type="text" placeholder="Ej. Anestesi√≥logo, Pediatra, Ginec√≥logo..." />
          </div>
          <div class="form-field">
            <label for="locationInput">Estado o ciudad</label>
            <input id="locationInput" type="text" placeholder="Ej. Ciudad de M√©xico, Jalisco, BCS..." />
          </div>
          <div class="form-field">
            <label for="institutionTypeSelect">Tipo de instituci√≥n (opcional)</label>
            <select id="institutionTypeSelect">
              <option value="">Cualquiera</option>
              <option value="publica">Hospital p√∫blico</option>
              <option value="privada">Cl√≠nica u hospital privado</option>
              <option value="consultorio">Consultorio</option>
            </select>
          </div>
        </form>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
          <button id="searchButton" class="search-button">
            <span class="icon">üîç</span>
            <span>Buscar m√©dicos</span>
          </button>
          <span class="chip">
            <span class="chip-dot"></span>
            Usa Google; se sincroniza con la nube (Firestore)
          </span>
        </div>
        <div id="statusMessage" class="status-message"></div>
      </div>

      <div class="card">
        <div class="results-header">
          <div>Resultados de b√∫squeda</div>
          <div id="resultsCount">0 m√©dicos encontrados</div>
        </div>
        <div id="resultsContainer" class="results-list"></div>
      </div>
    </section>

    <aside class="side-panel">
      <div class="card">
        <div class="side-section-title">Selecci√≥n para contactar</div>
        <div class="selection-summary">
          Seleccionados: <strong><span id="selectedCount">0</span></strong> m√©dico(s)
        </div>
        <ul id="selectedList" class="selected-list"></ul>
        <div class="panel-buttons">
          <button id="exportCsvBtn" class="btn-outline" type="button">
            üìÑ Exportar seleccionados a CSV
          </button>
          <button id="generateMessageBtn" class="btn-outline" type="button">
            ‚úâÔ∏è Generar mensaje de invitaci√≥n
          </button>
        </div>
        <div class="panel-subtitle">
          El CSV incluye nombre, especialidad, ubicaci√≥n, instituci√≥n, contacto, URL, comentarios y estatus.
        </div>
      </div>

      <div class="card">
        <div class="side-section-title">Plantilla de mensaje de invitaci√≥n</div>
        <textarea id="invitationTemplate" class="invitation-textarea"></textarea>
        <div class="panel-buttons" style="margin-top:6px;">
          <button id="copyInvitationBtn" class="btn-outline" type="button">
            üìã Copiar mensaje
          </button>
        </div>
        <div class="panel-subtitle">
          Usa este texto en correo o WhatsApp. Si seleccionas solo un m√©dico, se personalizar√° con su nombre y especialidad.
        </div>
      </div>

      <div class="card">
        <div class="side-section-title">M√©dicos contactados</div>
        <div class="panel-subtitle">
          Listado de m√©dicos con estatus distinto de "Pendiente". Se guarda en la nube (Firestore).
        </div>
        <div id="contactedList" class="contacted-list"></div>
      </div>
    </aside>
  </main>

  <footer class="app-footer">
    <div class="app-footer-inner">
      Esta herramienta usa informaci√≥n obtenida de fuentes p√∫blicas en internet √∫nicamente con fines de reclutamiento profesional
      responsable. Se recomienda respetar la Ley Federal de Protecci√≥n de Datos Personales en Posesi√≥n de los Particulares y
      normativas aplicables. No acceder a datos privados ni a sistemas que requieran autenticaci√≥n.
    </div>
  </footer>

  <!-- Toda la l√≥gica: Google Search + Firebase + app -->
  <script type="module">
    // ==============================
    // Firebase (App + Analytics + Firestore)
    // ==============================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      collection,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCx7j30Y2BIE-DkGWvkwg1OUHPnT3JFnIs",
      authDomain: "reclutador-de-medicos-e.firebaseapp.com",
      projectId: "reclutador-de-medicos-e",
      storageBucket: "reclutador-de-medicos-e.firebasestorage.app",
      messagingSenderId: "224579445862",
      appId: "1:224579445862:web:61b2c17a04518f67b279a7",
      measurementId: "G-S6TJF62TXY"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    // ==============================
    // Google Custom Search JSON API
    // ==============================

    // üëâ Aqu√≠ pegas TU API KEY nueva de Google
    const SEARCH_API_KEY = "PON_AQUI_TU_API_KEY_DE_GOOGLE";

    // Tu Search Engine ID (cx)
    const SEARCH_CX = "c72fe2e20aa5d4eb3";

    const SEARCH_API_ENDPOINT = "https://www.googleapis.com/customsearch/v1";

    // ==============================
    // Estado local
    // ==============================
    const LOCAL_STORAGE_KEY = "imssRecruitmentContactsV1";
    let contactsRegistry = {};
    let currentResults = [];
    let selectedDoctorIds = new Set();

    // ==============================
    // Utilidades generales
    // ==============================
    function normalizeString(str) {
      return (str || "").toString().trim().toLowerCase();
    }

    function buildDoctorId(doctor) {
      return (
        normalizeString(doctor.name) +
        "|" +
        normalizeString(doctor.institution || "") +
        "|" +
        normalizeString(doctor.url || "")
      );
    }

    function formatDateTime(date) {
      if (!date) return "";
      const d = new Date(date);
      if (isNaN(d.getTime())) return "";
      return (
        d.toLocaleDateString("es-MX", { year: "numeric", month: "short", day: "2-digit" }) +
        " " +
        d.toLocaleTimeString("es-MX", { hour: "2-digit", minute: "2-digit" })
      );
    }

    function showStatusMessage(text, isError = false) {
      const el = document.getElementById("statusMessage");
      el.textContent = text || "";
      el.classList.toggle("error", !!isError);
    }

    function saveContactsToStorage() {
      try {
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(contactsRegistry));
      } catch (err) {
        console.error("Error guardando en localStorage", err);
      }
    }

    function loadContactsFromStorage() {
      try {
        const raw = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed === "object") {
          contactsRegistry = parsed;
        }
      } catch (err) {
        console.error("Error leyendo de localStorage", err);
      }
    }

    async function saveContactToFirestore(record) {
      try {
        await setDoc(doc(db, "contacts", record.id), record, { merge: true });
      } catch (error) {
        console.error("Error guardando en Firestore", error);
      }
    }

    async function loadContactsFromFirestoreAndMerge() {
      try {
        const snap = await getDocs(collection(db, "contacts"));
        snap.forEach((d) => {
          const data = d.data();
          const id = data.id || d.id;
          if (!id) return;
          if (!contactsRegistry[id]) {
            contactsRegistry[id] = data;
          } else {
            contactsRegistry[id] = { ...contactsRegistry[id], ...data };
          }
        });
      } catch (error) {
        console.error("Error leyendo desde Firestore", error);
      }
    }

    function ensureDoctorRecord(doctor) {
      const id = doctor.id;
      if (!contactsRegistry[id]) {
        contactsRegistry[id] = {
          id,
          name: doctor.name || "",
          specialty: doctor.specialty || "",
          city: doctor.city || "",
          state: doctor.state || "",
          institution: doctor.institution || "",
          email: doctor.email || "",
          phone: doctor.phone || "",
          url: doctor.url || "",
          status: "Pendiente",
          notes: "",
          updatedAt: null
        };
      } else {
        const rec = contactsRegistry[id];
        rec.name = doctor.name || rec.name;
        rec.specialty = doctor.specialty || rec.specialty;
        rec.city = doctor.city || rec.city;
        rec.state = doctor.state || rec.state;
        rec.institution = doctor.institution || rec.institution;
        rec.email = doctor.email || rec.email;
        rec.phone = doctor.phone || rec.phone;
        rec.url = doctor.url || rec.url;
      }
      return contactsRegistry[id];
    }

    function updateDoctorRecord(id, updates) {
      if (!contactsRegistry[id]) return;
      Object.assign(contactsRegistry[id], updates);
      contactsRegistry[id].updatedAt = new Date().toISOString();
      saveContactsToStorage();
      saveContactToFirestore(contactsRegistry[id]);
      renderContactedPanel();
      updateResultsVisualState();
    }

    // ==============================
    // Datos MOCK de ejemplo
    // ==============================
    const MOCK_DOCTORS = [
      {
        name: "Dra. Ana Mar√≠a L√≥pez",
        specialty: "Ginecolog√≠a y Obstetricia",
        city: "La Paz",
        state: "Baja California Sur",
        institution: "Hospital Privado del Mar",
        email: "ana.lopez@example.com",
        phone: "+52 612 123 4567",
        url: "https://ejemplo-directorio-medico.mx/ana-maria-lopez"
      },
      {
        name: "Dr. Carlos Hern√°ndez",
        specialty: "Anestesiolog√≠a",
        city: "Tijuana",
        state: "Baja California",
        institution: "Hospital General Tijuana",
        email: "carlos.hernandez@example.com",
        phone: "+52 664 234 5678",
        url: "https://ejemplo-directorio-medico.mx/carlos-hernandez"
      },
      {
        name: "Dra. Patricia G√≥mez",
        specialty: "Pediatr√≠a",
        city: "Guadalajara",
        state: "Jalisco",
        institution: "Hospital Infantil de Occidente",
        email: "patricia.gomez@example.com",
        phone: "+52 33 3456 7890",
        url: "https://ejemplo-directorio-medico.mx/patricia-gomez"
      },
      {
        name: "Dr. Miguel Torres",
        specialty: "Cardiolog√≠a",
        city: "Ciudad de M√©xico",
        state: "Ciudad de M√©xico",
        institution: "Instituto Nacional de Cardiolog√≠a",
        email: "miguel.torres@example.com",
        phone: "+52 55 4567 8901",
        url: "https://ejemplo-directorio-medico.mx/miguel-torres"
      },
      {
        name: "Dra. Laura S√°nchez",
        specialty: "Medicina Interna",
        city: "Culiac√°n",
        state: "Sinaloa",
        institution: "Cl√≠nica del Pac√≠fico",
        email: "laura.sanchez@example.com",
        phone: "+52 667 567 8901",
        url: "https://ejemplo-directorio-medico.mx/laura-sanchez"
      }
    ].map((doc) => {
      const id = buildDoctorId(doc);
      return { id, ...doc };
    });

    function fetchDoctorsFromMock(filters) {
      const spec = normalizeString(filters.specialty);
      const loc = normalizeString(filters.location);
      const inst = normalizeString(filters.institutionType);

      const results = MOCK_DOCTORS.filter((doc) => {
        const matchSpec = !spec || normalizeString(doc.specialty).includes(spec);
        const matchLoc =
          !loc ||
          normalizeString(doc.city).includes(loc) ||
          normalizeString(doc.state).includes(loc);

        const isPublic =
          /general|instituto|imss|issste|hospital civil|hospital regional/i.test(
            doc.institution || ""
          );
        const isPrivate =
          /privad|cl√≠nica|clinica|sanatorio|medicenter/i.test(doc.institution || "");

        let matchInst = true;
        if (inst === "publica") matchInst = isPublic;
        if (inst === "privada") matchInst = isPrivate;
        if (inst === "consultorio") matchInst = !isPublic && !isPrivate;

        return matchSpec && matchLoc && matchInst;
      });

      return new Promise((resolve) => {
        setTimeout(() => resolve(results), 300);
      });
    }

    async function fetchDoctorsFromApi(filters) {
      const parts = [];

      if (filters.specialty) {
        parts.push(`m√©dico especialista ${filters.specialty}`);
      } else {
        parts.push("m√©dico especialista");
      }

      if (filters.location) {
        parts.push(filters.location);
      }

      parts.push("M√©xico hospital cl√≠nica consultorio");

      const query = parts.join(" ");

      const params = new URLSearchParams({
        key: SEARCH_API_KEY,
        cx: SEARCH_CX,
        q: query,
        num: "10",
        lr: "lang_es",
        gl: "mx"
      });

      const url = `${SEARCH_API_ENDPOINT}?${params.toString()}`;

      const response = await fetch(url);
      if (!response.ok) {
        throw new Error("Error en la respuesta de Google Custom Search");
      }

      const data = await response.json();
      const items = data.items || [];

      const mapped = items.map((item) => {
        const title = item.title || "";
        const snippet = item.snippet || "";
        const link = item.link || "";

        const split = title.split(/[-‚Äì|]/);
        const namePart = (split[0] || "").trim();
        const restTitle = (split[1] || "").trim();

        const name = namePart || "M√©dico sin nombre detectado";
        let specialty = "";

        if (restTitle) {
          specialty = restTitle;
        } else if (/cardio|pediatr|ginec|anestesi|intern/i.test(snippet)) {
          specialty = snippet;
        }

        const doctor = {
          name,
          specialty,
          city: "",
          state: "",
          institution: "",
          email: "",
          phone: "",
          url: link
        };

        const id = buildDoctorId(doctor);
        return { id, ...doctor };
      });

      return mapped;
    }

    async function searchDoctors(filters) {
      const apiConfigured =
        SEARCH_API_KEY &&
        SEARCH_API_KEY !== AIzaSyBLJoODUbvgaxime6_NVvEfmRD2YqkLj-E &&
        SEARCH_CX &&
        SEARCH_CX !== "";

      try {
        if (apiConfigured) {
          showStatusMessage("Buscando m√©dicos en Google (Custom Search)...");
          const results = await fetchDoctorsFromApi(filters);
          showStatusMessage("");
          if (!results.length) {
            showStatusMessage(
              "Google no devolvi√≥ resultados para esos criterios. Puedes ajustar filtros o revisar la configuraci√≥n del buscador."
            );
          }
          return results;
        } else {
          showStatusMessage(
            "No hay API de Google configurada. Usando resultados de ejemplo (mock)."
          );
          return await fetchDoctorsFromMock(filters);
        }
      } catch (err) {
        console.error("Error en la b√∫squeda", err);
        showStatusMessage(
          "Error al consultar la API de Google Custom Search. Revisa la API key, el cx y la cuota.",
          true
        );
        return await fetchDoctorsFromMock(filters);
      }
    }

    function updateResultsCount() {
      const el = document.getElementById("resultsCount");
      el.textContent = `${currentResults.length} m√©dico(s) encontrados`;
    }

    function createStatusBadgeElement(status) {
      const span = document.createElement("span");
      span.classList.add("badge");

      let cls = "badge-pending";
      if (status === "Le interes√≥") cls = "badge-interested";
      else if (status === "Rechaz√≥") cls = "badge-rejected";
      else if (status === "En seguimiento") cls = "badge-followup";

      span.classList.add(cls);
      span.textContent = status || "Pendiente";
      return span;
    }

    function updateCardVisualStatus(card, status) {
      card.classList.remove(
        "status-pendiente",
        "status-interesado",
        "status-rechazo",
        "status-seguimiento",
        "doctor-card--contacted"
      );
      let cls = "status-pendiente";
      let contacted = false;
      if (status === "Le interes√≥") {
        cls = "status-interesado";
        contacted = true;
      } else if (status === "Rechaz√≥") {
        cls = "status-rechazo";
        contacted = true;
      } else if (status === "En seguimiento") {
        cls = "status-seguimiento";
        contacted = true;
      }
      card.classList.add(cls);
      if (contacted) {
        card.classList.add("doctor-card--contacted");
      }
    }

    function renderResults() {
      const container = document.getElementById("resultsContainer");
      container.innerHTML = "";

      if (!currentResults.length) {
        const emptyMsg = document.createElement("div");
        emptyMsg.style.fontSize = "0.85rem";
        emptyMsg.style.color = "#78909c";
        emptyMsg.textContent = "No hay resultados para los filtros indicados.";
        container.appendChild(emptyMsg);
        updateResultsCount();
        return;
      }

      currentResults.forEach((doctor) => {
        const record = ensureDoctorRecord(doctor);

        const card = document.createElement("div");
        card.classList.add("card", "doctor-card");
        card.dataset.id = doctor.id;

        const header = document.createElement("div");
        header.classList.add("card-header");

        const titleWrap = document.createElement("div");
        const title = document.createElement("div");
        title.classList.add("card-title");
        title.textContent = doctor.name;
        const subtitle = document.createElement("div");
        subtitle.style.fontSize = "0.8rem";
        subtitle.style.color = "#607d8b";
        subtitle.textContent = doctor.specialty || "Especialidad no especificada";

        titleWrap.appendChild(title);
        titleWrap.appendChild(subtitle);

        const badgeContainer = document.createElement("div");
        badgeContainer.classList.add("status-pill");
        const statusBadge = createStatusBadgeElement(record.status);
        const smallText = document.createElement("span");
        smallText.style.fontSize = "0.75rem";
        smallText.style.color = "#78909c";
        smallText.textContent = record.updatedAt ? `Actualizado: ${formatDateTime(record.updatedAt)}` : "";
        badgeContainer.appendChild(statusBadge);
        if (smallText.textContent) badgeContainer.appendChild(smallText);

        header.appendChild(titleWrap);
        header.appendChild(badgeContainer);
        card.appendChild(header);

        const meta = document.createElement("div");
        meta.classList.add("doctor-meta");

        const metaLeft = document.createElement("div");
        metaLeft.classList.add("doctor-meta-item");
        metaLeft.innerHTML =
          `<span class="doctor-meta-label">Ubicaci√≥n:</span> ` +
          `${doctor.city || ""}${doctor.city && doctor.state ? ", " : ""}${doctor.state || ""}`;

        const metaRight = document.createElement("div");
        metaRight.classList.add("doctor-meta-item");
        metaRight.innerHTML =
          `<span class="doctor-meta-label">Instituci√≥n:</span> ${doctor.institution || "No especificada"}`;

        meta.appendChild(metaLeft);
        meta.appendChild(metaRight);
        card.appendChild(meta);

        const actions = document.createElement("div");
        actions.classList.add("doctor-actions");

        const profileBtn = document.createElement("button");
        profileBtn.type = "button";
        profileBtn.classList.add("btn-ghost", "primary");
        profileBtn.innerHTML = "üåê Ver perfil";
        profileBtn.addEventListener("click", () => {
          if (doctor.url) {
            window.open(doctor.url, "_blank", "noopener");
          } else {
            alert("No se detect√≥ URL p√∫blica para este m√©dico.");
          }
        });

        const contactBtn = document.createElement("button");
        contactBtn.type = "button";
        contactBtn.classList.add("btn-ghost");
        contactBtn.innerHTML = "üìã Copiar contacto";
        contactBtn.addEventListener("click", async () => {
          const lines = [];
          lines.push(doctor.name);
          if (doctor.specialty) lines.push(doctor.specialty);
          if (doctor.city || doctor.state) {
            lines.push(`${doctor.city || ""}${doctor.city && doctor.state ? ", " : ""}${doctor.state || ""}`);
          }
          if (doctor.institution) lines.push(doctor.institution);
          if (doctor.email) lines.push(`Email: ${doctor.email}`);
          if (doctor.phone) lines.push(`Tel√©fono: ${doctor.phone}`);
          if (doctor.url) lines.push(`Perfil: ${doctor.url}`);

          const text = lines.join("\n");
          try {
            await navigator.clipboard.writeText(text);
            alert("Datos de contacto copiados al portapapeles.");
          } catch (err) {
            console.error("Error copiando al portapapeles", err);
            alert("No se pudo copiar al portapapeles. Copia manualmente.");
          }
        });

        const contactInfoSpan = document.createElement("span");
        contactInfoSpan.style.fontSize = "0.78rem";
        contactInfoSpan.style.color = "#78909c";
        let parts = [];
        if (doctor.email) parts.push("Email");
        if (doctor.phone) parts.push("Tel√©fono");
        contactInfoSpan.textContent = parts.length
          ? `Contacto disponible: ${parts.join(" y ")}`
          : "No se detect√≥ email/tel√©fono p√∫blico";

        actions.appendChild(profileBtn);
        actions.appendChild(contactBtn);
        actions.appendChild(contactInfoSpan);
        card.appendChild(actions);

        const followup = document.createElement("div");
        followup.classList.add("doctor-followup");

        const notesField = document.createElement("div");
        notesField.classList.add("form-field");
        const notesLabel = document.createElement("label");
        notesLabel.textContent = "Comentarios / notas";
        const notesTextarea = document.createElement("textarea");
        notesTextarea.value = record.notes || "";
        notesTextarea.placeholder = "Ej. Ya se le envi√≥ correo el 10/12, pidi√≥ m√°s informaci√≥n, etc.";
        notesTextarea.addEventListener("change", () => {
          updateDoctorRecord(doctor.id, { notes: notesTextarea.value });
        });
        notesField.appendChild(notesLabel);
        notesField.appendChild(notesTextarea);

        const statusField = document.createElement("div");
        statusField.classList.add("form-field");
        const statusLabel = document.createElement("label");
        statusLabel.textContent = "Estatus del contacto";
        const statusSelect = document.createElement("select");
        ["Pendiente", "Le interes√≥", "Rechaz√≥", "En seguimiento"].forEach((opt) => {
          const option = document.createElement("option");
          option.value = opt;
          option.textContent = opt;
          if (record.status === opt) option.selected = true;
          statusSelect.appendChild(option);
        });
        statusSelect.addEventListener("change", () => {
          const newStatus = statusSelect.value || "Pendiente";
          updateDoctorRecord(doctor.id, { status: newStatus });
        });
        statusField.appendChild(statusLabel);
        statusField.appendChild(statusSelect);

        followup.appendChild(notesField);
        followup.appendChild(statusField);
        card.appendChild(followup);

        const selectRow = document.createElement("div");
        selectRow.classList.add("doctor-select-row");

        const selectLabelWrap = document.createElement("label");
        selectLabelWrap.style.display = "inline-flex";
        selectLabelWrap.style.alignItems = "center";
        selectLabelWrap.style.gap = "6px";
        const selectCheckbox = document.createElement("input");
        selectCheckbox.type = "checkbox";
        selectCheckbox.checked = selectedDoctorIds.has(doctor.id);
        const selectText = document.createElement("span");
        selectText.textContent = "Seleccionar para contactar";
        selectLabelWrap.appendChild(selectCheckbox);
        selectLabelWrap.appendChild(selectText);

        const contactState = document.createElement("span");
        contactState.classList.add("chip");
        const dot = document.createElement("span");
        dot.classList.add("chip-dot");
        const label = document.createElement("span");
        label.textContent =
          record.status === "Pendiente" ? "A√∫n no contactado" : "Ya se le contact√≥";
        contactState.appendChild(dot);
        contactState.appendChild(label);

        selectRow.appendChild(selectLabelWrap);
        selectRow.appendChild(contactState);
        card.appendChild(selectRow);

        selectCheckbox.addEventListener("change", () => {
          if (selectCheckbox.checked) {
            selectedDoctorIds.add(doctor.id);
          } else {
            selectedDoctorIds.delete(doctor.id);
          }
          updateSelectionPanelUI();
        });

        updateCardVisualStatus(card, record.status);
        container.appendChild(card);
      });

      updateResultsCount();
      updateSelectionPanelUI();
    }

    function updateResultsVisualState() {
      const container = document.getElementById("resultsContainer");
      const cards = container.querySelectorAll(".doctor-card");
      cards.forEach((card) => {
        const id = card.dataset.id;
        const record = contactsRegistry[id];
        if (!record) return;
        updateCardVisualStatus(card, record.status);

        const chipLabel = card.querySelector(".doctor-select-row .chip span:last-child");
        if (chipLabel) {
          chipLabel.textContent =
            record.status === "Pendiente" ? "A√∫n no contactado" : "Ya se le contact√≥";
        }

        const badgeContainer = card.querySelector(".card-header .status-pill");
        if (badgeContainer) {
          const oldBadge = badgeContainer.querySelector(".badge");
          const newBadge = createStatusBadgeElement(record.status);
          if (oldBadge) badgeContainer.replaceChild(newBadge, oldBadge);
          else badgeContainer.insertBefore(newBadge, badgeContainer.firstChild);
          const small = badgeContainer.querySelector("span:not(.badge)");
          if (small) {
            small.textContent = record.updatedAt
              ? `Actualizado: ${formatDateTime(record.updatedAt)}`
              : "";
          }
        }
      });
    }

    function updateSelectionPanelUI() {
      const countEl = document.getElementById("selectedCount");
      const listEl = document.getElementById("selectedList");
      countEl.textContent = selectedDoctorIds.size;
      listEl.innerHTML = "";

      if (!selectedDoctorIds.size) {
        const li = document.createElement("li");
        li.style.color = "#90a4ae";
        li.textContent = "No hay m√©dicos seleccionados.";
        listEl.appendChild(li);
        return;
      }

      selectedDoctorIds.forEach((id) => {
        const doc = currentResults.find((d) => d.id === id) || contactsRegistry[id];
        if (!doc) return;
        const rec = contactsRegistry[id];
        const li = document.createElement("li");
        li.textContent = `${doc.name} ‚Äì ${doc.specialty || "Especialidad no especificada"} (${
          rec?.status || "Pendiente"
        })`;
        listEl.appendChild(li);
      });
    }

    function exportSelectedToCsv() {
      if (!selectedDoctorIds.size) {
        alert("No hay m√©dicos seleccionados para exportar.");
        return;
      }

      const rows = [];
      const header = [
        "Nombre",
        "Especialidad",
        "Ciudad",
        "Estado",
        "Instituci√≥n",
        "Email",
        "Tel√©fono",
        "URL",
        "Comentarios",
        "Estatus"
      ];
      rows.push(header);

      selectedDoctorIds.forEach((id) => {
        const doc = currentResults.find((d) => d.id === id) || contactsRegistry[id];
        if (!doc) return;
        const rec = contactsRegistry[id] || {};
        const row = [
          doc.name || "",
          doc.specialty || "",
          doc.city || "",
          doc.state || "",
          doc.institution || "",
          doc.email || "",
          doc.phone || "",
          doc.url || "",
          rec.notes || "",
          rec.status || "Pendiente"
        ];
        rows.push(row);
      });

      const csv = rows
        .map((row) =>
          row
            .map((cell) => {
              const c = (cell || "").toString().replace(/"/g, '""');
              return `"${c}"`;
            })
            .join(",")
        )
        .join("\r\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "medicos_seleccionados_imss_bcs.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function setDefaultInvitationTemplate() {
      const textarea = document.getElementById("invitationTemplate");
      textarea.value =
        "Estimado(a) {nombre_medico},\n\n" +
        "Reciba un cordial saludo. Mi nombre es [Tu nombre] y formo parte del equipo de reclutamiento del Instituto Mexicano del Seguro Social (IMSS) en Baja California Sur.\n\n" +
        "Hemos identificado su trayectoria profesional en el √°rea de {especialidad} y nos gustar√≠a explorar con usted la posibilidad de integrarse a nuestro equipo, ya sea de manera inmediata o en un futuro cercano.\n\n" +
        "En el IMSS Baja California Sur contamos con oportunidades laborales para m√©dicos especialistas, con un enfoque en brindar atenci√≥n de calidad a la poblaci√≥n derechohabiente, as√≠ como opciones de desarrollo profesional y estabilidad laboral.\n\n" +
        "Si le interesa conocer m√°s detalles sobre vacantes, condiciones de trabajo y proceso de incorporaci√≥n, con gusto puedo compartirle informaci√≥n adicional y agendar una llamada en la fecha y hora que mejor le acomode.\n\n" +
        "Quedo atento(a) a sus comentarios.\n\n" +
        "Atentamente,\n" +
        "[Tu nombre]\n" +
        "[Tu puesto]\n" +
        "IMSS Baja California Sur\n" +
        "[Tus datos de contacto]";
    }

    function generateInvitationMessage() {
      const textarea = document.getElementById("invitationTemplate");

      if (selectedDoctorIds.size === 1) {
        const id = Array.from(selectedDoctorIds)[0];
        const doc = currentResults.find((d) => d.id === id) || contactsRegistry[id];
        if (doc) {
          textarea.value =
            `Estimado(a) ${doc.name},\n\n` +
            "Reciba un cordial saludo. Mi nombre es [Tu nombre] y formo parte del equipo de reclutamiento del Instituto Mexicano del Seguro Social (IMSS) en Baja California Sur.\n\n" +
            `Hemos identificado su trayectoria profesional en el √°rea de ${doc.specialty ||
              "su especialidad"} y nos gustar√≠a explorar con usted la posibilidad de integrarse a nuestro equipo, ya sea de manera inmediata o en un futuro cercano.\n\n` +
            "En el IMSS Baja California Sur contamos con oportunidades laborales para m√©dicos especialistas, con un enfoque en brindar atenci√≥n de calidad a la poblaci√≥n derechohabiente, as√≠ como opciones de desarrollo profesional y estabilidad laboral.\n\n" +
            "Si le interesa conocer m√°s detalles sobre vacantes, condiciones de trabajo y proceso de incorporaci√≥n, con gusto puedo compartirle informaci√≥n adicional y agendar una llamada en la fecha y hora que mejor le acomode.\n\n" +
            "Quedo atento(a) a sus comentarios.\n\n" +
            "Atentamente,\n" +
            "[Tu nombre]\n" +
            "[Tu puesto]\n" +
            "IMSS Baja California Sur\n" +
            "[Tus datos de contacto]";
          return;
        }
      }

      setDefaultInvitationTemplate();
    }

    async function copyInvitationToClipboard() {
      const textarea = document.getElementById("invitationTemplate");
      try {
        await navigator.clipboard.writeText(textarea.value || "");
        alert("Mensaje copiado al portapapeles.");
      } catch (err) {
        console.error("Error copiando mensaje", err);
        alert("No se pudo copiar el mensaje. Copia manualmente el texto.");
      }
    }

    function renderContactedPanel() {
      const container = document.getElementById("contactedList");
      container.innerHTML = "";

      const records = Object.values(contactsRegistry).filter(
        (rec) => rec.status && rec.status !== "Pendiente"
      );

      if (!records.length) {
        const msg = document.createElement("div");
        msg.style.fontSize = "0.8rem";
        msg.style.color = "#90a4ae";
        msg.textContent = "A√∫n no hay m√©dicos marcados como contactados.";
        container.appendChild(msg);
        return;
      }

      records.sort((a, b) => {
        const ta = a.updatedAt ? new Date(a.updatedAt).getTime() : 0;
        const tb = b.updatedAt ? new Date(b.updatedAt).getTime() : 0;
        return tb - ta;
      });

      records.forEach((rec) => {
        const item = document.createElement("div");
        item.classList.add("contacted-item");

        const header = document.createElement("div");
        header.classList.add("contacted-header");

        const nameEl = document.createElement("div");
        nameEl.classList.add("contacted-name");
        nameEl.textContent = rec.name;

        const statusBadge = createStatusBadgeElement(rec.status);

        header.appendChild(nameEl);
        header.appendChild(statusBadge);
        item.appendChild(header);

        const meta = document.createElement("div");
        meta.classList.add("contacted-meta");
        meta.textContent = `${rec.specialty || "Especialidad no especificada"} ¬∑ ${
          rec.city || ""
        }${rec.city && rec.state ? ", " : ""}${rec.state || ""}`;
        item.appendChild(meta);

        const controls = document.createElement("div");
        controls.classList.add("contacted-controls");

        const notesField = document.createElement("div");
        notesField.classList.add("form-field");
        const notesLabel = document.createElement("label");
        notesLabel.textContent = "Comentarios";
        const notesTextarea = document.createElement("textarea");
        notesTextarea.value = rec.notes || "";
        notesTextarea.addEventListener("change", () => {
          updateDoctorRecord(rec.id, { notes: notesTextarea.value });
        });
        notesField.appendChild(notesLabel);
        notesField.appendChild(notesTextarea);

        const statusField = document.createElement("div");
        statusField.classList.add("form-field");
        const statusLabel = document.createElement("label");
        statusLabel.textContent = "Estatus";
        const statusSelect = document.createElement("select");
        ["Pendiente", "Le interes√≥", "Rechaz√≥", "En seguimiento"].forEach((opt) => {
          const option = document.createElement("option");
          option.value = opt;
          option.textContent = opt;
          if (rec.status === opt) option.selected = true;
          statusSelect.appendChild(option);
        });
        statusSelect.addEventListener("change", () => {
          const newStatus = statusSelect.value || "Pendiente";
          updateDoctorRecord(rec.id, { status: newStatus });
        });
        statusField.appendChild(statusLabel);
        statusField.appendChild(statusSelect);

        controls.appendChild(notesField);
        controls.appendChild(statusField);
        item.appendChild(controls);

        container.appendChild(item);
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      (async () => {
        loadContactsFromStorage();
        await loadContactsFromFirestoreAndMerge();
        setDefaultInvitationTemplate();
        renderContactedPanel();

        const searchForm = document.getElementById("searchForm");
        const searchButton = document.getElementById("searchButton");
        const exportCsvBtn = document.getElementById("exportCsvBtn");
        const generateMsgBtn = document.getElementById("generateMessageBtn");
        const copyInvitationBtn = document.getElementById("copyInvitationBtn");

        async function handleSearch() {
          const specialty = document.getElementById("specialtyInput").value;
          const location = document.getElementById("locationInput").value;
          const institutionType = document.getElementById("institutionTypeSelect").value;

          selectedDoctorIds.clear();
          updateSelectionPanelUI();
          showStatusMessage("Buscando m√©dicos...");

          searchButton.disabled = true;
          try {
            const results = await searchDoctors({ specialty, location, institutionType });
            currentResults = results.map((doc) => {
              if (!doc.id) {
                doc.id = buildDoctorId(doc);
              }
              ensureDoctorRecord(doc);
              return doc;
            });
            renderResults();
            if (!results.length) {
              // mensajes ya manejados
            } else {
              showStatusMessage("");
            }
          } finally {
            searchButton.disabled = false;
          }
        }

        searchButton.addEventListener("click", (e) => {
          e.preventDefault();
          handleSearch();
        });

        searchForm.addEventListener("submit", (e) => {
          e.preventDefault();
          handleSearch();
        });

        exportCsvBtn.addEventListener("click", () => exportSelectedToCsv());
        generateMsgBtn.addEventListener("click", () => generateInvitationMessage());
        copyInvitationBtn.addEventListener("click", () => copyInvitationToClipboard());

        // B√∫squeda inicial (mock o Google seg√∫n config)
        const results = await searchDoctors({ specialty: "", location: "", institutionType: "" });
        currentResults = results.map((doc) => {
          if (!doc.id) doc.id = buildDoctorId(doc);
          ensureDoctorRecord(doc);
          return doc;
        });
        renderResults();
      })();
    });
  </script>
</body>
</html>
