        const snippet = item.snippet || "";
        const link = item.link || "";

        const split = title.split(/[-â€“|]/);
        const namePart = (split[0] || "").trim();
        const restTitle = (split[1] || "").trim();

        const name = namePart || "MÃ©dico sin nombre detectado";
        let specialty = "";

        if (restTitle) {
          specialty = restTitle;
        } else if (/cardio|pediatr|ginec|anestesi|intern/i.test(snippet)) {
          specialty = snippet;
        }

        const doctor = {
          name,
          specialty,
          city: "",
          state: "",
          institution: "",
          email: "",
          phone: "",
          url: link
        };

        const id = buildDoctorId(doctor);
        return { id, ...doctor };
      });

      return mapped;
    }

    async function searchDoctors(filters) {
      const apiConfigured =
        SEARCH_API_KEY &&
        SEARCH_API_KEY !== "PON_AQUI_TU_API_KEY_DE_GOOGLE" &&
        SEARCH_CX &&
        SEARCH_CX !== "";

      try {
        if (apiConfigured) {
          showStatusMessage("Buscando mÃ©dicos en Google (Custom Search)...");
          const results = await fetchDoctorsFromApi(filters);
          showStatusMessage("");
          if (!results.length) {
            showStatusMessage(
              "Google no devolviÃ³ resultados para esos criterios. Puedes ajustar filtros o revisar la configuraciÃ³n del buscador."
            );
          }
          return results;
        } else {
          showStatusMessage(
            "No hay API de Google configurada. Usando resultados de ejemplo (mock)."
          );
          return await fetchDoctorsFromMock(filters);
        }
      } catch (err) {
        console.error("Error en la bÃºsqueda", err);
        showStatusMessage(
          "Error al consultar la API de Google Custom Search. Revisa la API key, el cx y la cuota.",
          true
        );
        return await fetchDoctorsFromMock(filters);
      }
    }

    function updateResultsCount() {
      const el = document.getElementById("resultsCount");
      el.textContent = `${currentResults.length} mÃ©dico(s) encontrados`;
    }

    function createStatusBadgeElement(status) {
      const span = document.createElement("span");
      span.classList.add("badge");

      let cls = "badge-pending";
      if (status === "Le interesÃ³") cls = "badge-interested";
      else if (status === "RechazÃ³") cls = "badge-rejected";
      else if (status === "En seguimiento") cls = "badge-followup";

      span.classList.add(cls);
      span.textContent = status || "Pendiente";
      return span;
    }

    function updateCardVisualStatus(card, status) {
      card.classList.remove(
        "status-pendiente",
        "status-interesado",
        "status-rechazo",
        "status-seguimiento",
        "doctor-card--contacted"
      );
      let cls = "status-pendiente";
      let contacted = false;
      if (status === "Le interesÃ³") {
        cls = "status-interesado";
        contacted = true;
      } else if (status === "RechazÃ³") {
        cls = "status-rechazo";
        contacted = true;
      } else if (status === "En seguimiento") {
        cls = "status-seguimiento";
        contacted = true;
      }
      card.classList.add(cls);
      if (contacted) {
        card.classList.add("doctor-card--contacted");
      }
    }

    function renderResults() {
      const container = document.getElementById("resultsContainer");
      container.innerHTML = "";

      if (!currentResults.length) {
        const emptyMsg = document.createElement("div");
        emptyMsg.style.fontSize = "0.85rem";
        emptyMsg.style.color = "#78909c";
        emptyMsg.textContent = "No hay resultados para los filtros indicados.";
        container.appendChild(emptyMsg);
        updateResultsCount();
        return;
      }

      currentResults.forEach((doctor) => {
        const record = ensureDoctorRecord(doctor);

        // ðŸ‘‡ GUARDAR CADA DOCTOR EN FIRESTORE Y LOCALSTORAGE
        saveContactToFirestore(record);
        saveContactsToStorage();
        // ðŸ‘†

        const card = document.createElement("div");
        card.classList.add("card", "doctor-card");
        card.dataset.id = doctor.id;

        const header = document.createElement("div");
        header.classList.add("card-header");

        const titleWrap = document.createElement("div");
        const title = document.createElement("div");
        title.classList.add("card-title");
        title.textContent = doctor.name;
        const subtitle = document.createElement("div");
        subtitle.style.fontSize = "0.8rem";
        subtitle.style.color = "#607d8b";
        subtitle.textContent = doctor.specialty || "Especialidad no especificada";

        titleWrap.appendChild(title);
        titleWrap.appendChild(subtitle);

        const badgeContainer = document.createElement("div");
        badgeContainer.classList.add("status-pill");
        const statusBadge = createStatusBadgeElement(record.status);
        const smallText = document.createElement("span");
        smallText.style.fontSize = "0.75rem";
        smallText.style.color = "#78909c";
        smallText.textContent = record.updatedAt ? `Actualizado: ${formatDateTime(record.updatedAt)}` : "";
        badgeContainer.appendChild(statusBadge);
        if (smallText.textContent) badgeContainer.appendChild(smallText);

        header.appendChild(titleWrap);
        header.appendChild(badgeContainer);
        card.appendChild(header);

        const meta = document.createElement("div");
        meta.classList.add("doctor-meta");

        const metaLeft = document.createElement("div");
        metaLeft.classList.add("doctor-meta-item");
        metaLeft.innerHTML =
          `<span class="doctor-meta-label">UbicaciÃ³n:</span> ` +
          `${doctor.city || ""}${doctor.city && doctor.state ? ", " : ""}${doctor.state || ""}`;

        const metaRight = document.createElement("div");
        metaRight.classList.add("doctor-meta-item");
        metaRight.innerHTML =
          `<span class="doctor-meta-label">InstituciÃ³n:</span> ${doctor.institution || "No especificada"}`;

        meta.appendChild(metaLeft);
        meta.appendChild(metaRight);
        card.appendChild(meta);

        const actions = document.createElement("div");
        actions.classList.add("doctor-actions");

        const profileBtn = document.createElement("button");
        profileBtn.type = "button";
        profileBtn.classList.add("btn-ghost", "primary");
        profileBtn.innerHTML = "ðŸŒ Ver perfil";
        profileBtn.addEventListener("click", () => {
          if (doctor.url) {
            window.open(doctor.url, "_blank", "noopener");
          } else {
            alert("No se detectÃ³ URL pÃºblica para este mÃ©dico.");
          }
        });

        const contactBtn = document.createElement("button");
        contactBtn.type = "button";
        contactBtn.classList.add("btn-ghost");
        contactBtn.innerHTML = "ðŸ“‹ Copiar contacto";
        contactBtn.addEventListener("click", async () => {
          const lines = [];
          lines.push(doctor.name);
          if (doctor.specialty) lines.push(doctor.specialty);
          if (doctor.city || doctor.state) {
            lines.push(`${doctor.city || ""}${doctor.city && doctor.state ? ", " : ""}${doctor.state || ""}`);
          }
          if (doctor.institution) lines.push(doctor.institution);
          if (doctor.email) lines.push(`Email: ${doctor.email}`);
          if (doctor.phone) lines.push(`TelÃ©fono: ${doctor.phone}`);
          if (doctor.url) lines.push(`Perfil: ${doctor.url}`);

          const text = lines.join("\n");
          try {
            await navigator.clipboard.writeText(text);
            alert("Datos de contacto copiados al portapapeles.");
          } catch (err) {
            console.error("Error copiando al portapapeles", err);
            alert("No se pudo copiar al portapapeles. Copia manualmente.");
          }
        });

        const contactInfoSpan = document.createElement("span");
        contactInfoSpan.style.fontSize = "0.78rem";
        contactInfoSpan.style.color = "#78909c";
        let parts = [];
        if (doctor.email) parts.push("Email");
        if (doctor.phone) parts.push("TelÃ©fono");
        contactInfoSpan.textContent = parts.length
          ? `Contacto disponible: ${parts.join(" y ")}`
          : "No se detectÃ³ email/telÃ©fono pÃºblico";

        actions.appendChild(profileBtn);
        actions.appendChild(contactBtn);
        actions.appendChild(contactInfoSpan);
        card.appendChild(actions);

        const followup = document.createElement("div");
        followup.classList.add("doctor-followup");

        const notesField = document.createElement("div");
        notesField.classList.add("form-field");
        const notesLabel = document.createElement("label");
        notesLabel.textContent = "Comentarios / notas";
        const notesTextarea = document.createElement("textarea");
        notesTextarea.value = record.notes || "";
        notesTextarea.placeholder = "Ej. Ya se le enviÃ³ correo el 10/12, pidiÃ³ mÃ¡s informaciÃ³n, etc.";
        notesTextarea.addEventListener("change", () => {
          updateDoctorRecord(doctor.id, { notes: notesTextarea.value });
        });
        notesField.appendChild(notesLabel);
        notesField.appendChild(notesTextarea);

        const statusField = document.createElement("div");
        statusField.classList.add("form-field");
        const statusLabel = document.createElement("label");
        statusLabel.textContent = "Estatus del contacto";
        const statusSelect = document.createElement("select");
        ["Pendiente", "Le interesÃ³", "RechazÃ³", "En seguimiento"].forEach((opt) => {
          const option = document.createElement("option");
          option.value = opt;
          option.textContent = opt;
          if (record.status === opt) option.selected = true;
          statusSelect.appendChild(option);
        });
        statusSelect.addEventListener("change", () => {
          const newStatus = statusSelect.value || "Pendiente";
          updateDoctorRecord(doctor.id, { status: newStatus });
        });
        statusField.appendChild(statusLabel);
        statusField.appendChild(statusSelect);

        followup.appendChild(notesField);
        followup.appendChild(statusField);
        card.appendChild(followup);

        const selectRow = document.createElement("div");
        selectRow.classList.add("doctor-select-row");

        const selectLabelWrap = document.createElement("label");
        selectLabelWrap.style.display = "inline-flex";
        selectLabelWrap.style.alignItems = "center";
        selectLabelWrap.style.gap = "6px";
        const selectCheckbox = document.createElement("input");
        selectCheckbox.type = "checkbox";
        selectCheckbox.checked = selectedDoctorIds.has(doctor.id);
        const selectText = document.createElement("span");
        selectText.textContent = "Seleccionar para contactar";
        selectLabelWrap.appendChild(selectCheckbox);
        selectLabelWrap.appendChild(selectText);

        const contactState = document.createElement("span");
        contactState.classList.add("chip");
        const dot = document.createElement("span");
        dot.classList.add("chip-dot");
        const label = document.createElement("span");
        label.textContent =
          record.status === "Pendiente" ? "AÃºn no contactado" : "Ya se le contactÃ³";
        contactState.appendChild(dot);
        contactState.appendChild(label);

        selectRow.appendChild(selectLabelWrap);
        selectRow.appendChild(contactState);
        card.appendChild(selectRow);

        selectCheckbox.addEventListener("change", () => {
          if (selectCheckbox.checked) {
            selectedDoctorIds.add(doctor.id);
          } else {
            selectedDoctorIds.delete(doctor.id);
          }
          updateSelectionPanelUI();
        });

        updateCardVisualStatus(card, record.status);
        container.appendChild(card);
      });

      updateResultsCount();
      updateSelectionPanelUI();
    }

    function updateResultsVisualState() {
      const container = document.getElementById("resultsContainer");
      const cards = container.querySelectorAll(".doctor-card");
      cards.forEach((card) => {
        const id = card.dataset.id;
        const record = contactsRegistry[id];
        if (!record) return;
        updateCardVisualStatus(card, record.status);

        const chipLabel = card.querySelector(".doctor-select-row .chip span:last-child");
        if (chipLabel) {
          chipLabel.textContent =
            record.status === "Pendiente" ? "AÃºn no contactado" : "Ya se le contactÃ³";
        }

        const badgeContainer = card.querySelector(".card-header .status-pill");
        if (badgeContainer) {
          const oldBadge = badgeContainer.querySelector(".badge");
          const newBadge = createStatusBadgeElement(record.status);
          if (oldBadge) badgeContainer.replaceChild(newBadge, oldBadge);
          else badgeContainer.insertBefore(newBadge, badgeContainer.firstChild);
          const small = badgeContainer.querySelector("span:not(.badge)");
          if (small) {
            small.textContent = record.updatedAt
              ? `Actualizado: ${formatDateTime(record.updatedAt)}`
              : "";
          }
        }
      });
    }

    function updateSelectionPanelUI() {
      const countEl = document.getElementById("selectedCount");
      const listEl = document.getElementById("selectedList");
      countEl.textContent = selectedDoctorIds.size;
      listEl.innerHTML = "";

      if (!selectedDoctorIds.size) {
        const li = document.createElement("li");
        li.style.color = "#90a4ae";
        li.textContent = "No hay mÃ©dicos seleccionados.";
        listEl.appendChild(li);
        return;
      }

      selectedDoctorIds.forEach((id) => {
        const doc = currentResults.find((d) => d.id === id) || contactsRegistry[id];
        if (!doc) return;
        const rec = contactsRegistry[id];
        const li = document.createElement("li");
        li.textContent = `${doc.name} â€“ ${doc.specialty || "Especialidad no especificada"} (${
          rec?.status || "Pendiente"
        })`;
        listEl.appendChild(li);
      });
    }

    function exportSelectedToCsv() {
      if (!selectedDoctorIds.size) {
        alert("No hay mÃ©dicos seleccionados para exportar.");
        return;
      }

      const rows = [];
      const header = [
        "Nombre",
        "Especialidad",
        "Ciudad",
        "Estado",
        "InstituciÃ³n",
        "Email",
        "TelÃ©fono",
        "URL",
        "Comentarios",
        "Estatus"
      ];
      rows.push(header);

      selectedDoctorIds.forEach((id) => {
        const doc = currentResults.find((d) => d.id === id) || contactsRegistry[id];
        if (!doc) return;
        const rec = contactsRegistry[id] || {};
        const row = [
          doc.name || "",
          doc.specialty || "",
          doc.city || "",
          doc.state || "",
          doc.institution || "",
          doc.email || "",
          doc.phone || "",
          doc.url || "",
          rec.notes || "",
          rec.status || "Pendiente"
        ];
        rows.push(row);
      });

      const csv = rows
        .map((row) =>
          row
            .map((cell) => {
              const c = (cell || "").toString().replace(/"/g, '""');
              return `"${c}"`;
            })
            .join(",")
        )
        .join("\r\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "medicos_seleccionados_imss_bcs.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function setDefaultInvitationTemplate() {
      const textarea = document.getElementById("invitationTemplate");
      textarea.value =
        "Estimado(a) {nombre_medico},\n\n" +
        "Reciba un cordial saludo. Mi nombre es [Tu nombre] y formo parte del equipo de reclutamiento del Instituto Mexicano del Seguro Social (IMSS) en Baja California Sur.\n\n" +
        "Hemos identificado su trayectoria profesional en el Ã¡rea de {especialidad} y nos gustarÃ­a explorar con usted la posibilidad de integrarse a nuestro equipo, ya sea de manera inmediata o en un futuro cercano.\n\n" +
        "En el IMSS Baja California Sur contamos con oportunidades laborales para mÃ©dicos especialistas, con un enfoque en brindar atenciÃ³n de calidad a la poblaciÃ³n derechohabiente, asÃ­ como opciones de desarrollo profesional y estabilidad laboral.\n\n" +
        "Si le interesa conocer mÃ¡s detalles sobre vacantes, condiciones de trabajo y proceso de incorporaciÃ³n, con gusto puedo compartirle informaciÃ³n adicional y agendar una llamada en la fecha y hora que mejor le acomode.\n\n" +
        "Quedo atento(a) a sus comentarios.\n\n" +
        "Atentamente,\n" +
        "[Tu nombre]\n" +
        "[Tu puesto]\n" +
        "IMSS Baja California Sur\n" +
        "[Tus datos de contacto]";
    }

    function generateInvitationMessage() {
      const textarea = document.getElementById("invitationTemplate");

      if (selectedDoctorIds.size === 1) {
        const id = Array.from(selectedDoctorIds)[0];
        const doc = currentResults.find((d) => d.id === id) || contactsRegistry[id];
        if (doc) {
          textarea.value =
            `Estimado(a) ${doc.name},\n\n` +
            "Reciba un cordial saludo. Mi nombre es [Tu nombre] y formo parte del equipo de reclutamiento del Instituto Mexicano del Seguro Social (IMSS) en Baja California Sur.\n\n" +
            `Hemos identificado su trayectoria profesional en el Ã¡rea de ${doc.specialty ||
              "su especialidad"} y nos gustarÃ­a explorar con usted la posibilidad de integrarse a nuestro equipo, ya sea de manera inmediata o en un futuro cercano.\n\n` +
            "En el IMSS Baja California Sur contamos con oportunidades laborales para mÃ©dicos especialistas, con un enfoque en brindar atenciÃ³n de calidad a la poblaciÃ³n derechohabiente, asÃ­ como opciones de desarrollo profesional y estabilidad laboral.\n\n" +
            "Si le interesa conocer mÃ¡s detalles sobre vacantes, condiciones de trabajo y proceso de incorporaciÃ³n, con gusto puedo compartirle informaciÃ³n adicional y agendar una llamada en la fecha y hora que mejor le acomode.\n\n" +
            "Quedo atento(a) a sus comentarios.\n\n" +
            "Atentamente,\n" +
            "[Tu nombre]\n" +
            "[Tu puesto]\n" +
            "IMSS Baja California Sur\n" +
            "[Tus datos de contacto]";
          return;
        }
      }

      setDefaultInvitationTemplate();
    }

    async function copyInvitationToClipboard() {
      const textarea = document.getElementById("invitationTemplate");
      try {
        await navigator.clipboard.writeText(textarea.value || "");
        alert("Mensaje copiado al portapapeles.");
      } catch (err) {
        console.error("Error copiando mensaje", err);
        alert("No se pudo copiar el mensaje. Copia manualmente el texto.");
      }
    }

    function renderContactedPanel() {
      const container = document.getElementById("contactedList");
      container.innerHTML = "";

      const records = Object.values(contactsRegistry).filter(
        (rec) => rec.status && rec.status !== "Pendiente"
      );

      if (!records.length) {
        const msg = document.createElement("div");
        msg.style.fontSize = "0.8rem";
        msg.style.color = "#90a4ae";
        msg.textContent = "AÃºn no hay mÃ©dicos marcados como contactados.";
        container.appendChild(msg);
        return;
      }

      records.sort((a, b) => {
        const ta = a.updatedAt ? new Date(a.updatedAt).getTime() : 0;
        const tb = b.updatedAt ? new Date(b.updatedAt).getTime() : 0;
        return tb - ta;
      });

      records.forEach((rec) => {
        const item = document.createElement("div");
        item.classList.add("contacted-item");

        const header = document.createElement("div");
        header.classList.add("contacted-header");

        const nameEl = document.createElement("div");
        nameEl.classList.add("contacted-name");
        nameEl.textContent = rec.name;

        const statusBadge = createStatusBadgeElement(rec.status);

        header.appendChild(nameEl);
        header.appendChild(statusBadge);
        item.appendChild(header);

        const meta = document.createElement("div");
        meta.classList.add("contacted-meta");
        meta.textContent = `${rec.specialty || "Especialidad no especificada"} Â· ${
          rec.city || ""
        }${rec.city && rec.state ? ", " : ""}${rec.state || ""}`;
        item.appendChild(meta);

        const controls = document.createElement("div");
        controls.classList.add("contacted-controls");

        const notesField = document.createElement("div");
        notesField.classList.add("form-field");
        const notesLabel = document.createElement("label");
        notesLabel.textContent = "Comentarios";
        const notesTextarea = document.createElement("textarea");
        notesTextarea.value = rec.notes || "";
        notesTextarea.addEventListener("change", () => {
          updateDoctorRecord(rec.id, { notes: notesTextarea.value });
        });
        notesField.appendChild(notesLabel);
        notesField.appendChild(notesTextarea);

        const statusField = document.createElement("div");
        statusField.classList.add("form-field");
        const statusLabel = document.createElement("label");
        statusLabel.textContent = "Estatus";
        const statusSelect = document.createElement("select");
        ["Pendiente", "Le interesÃ³", "RechazÃ³", "En seguimiento"].forEach((opt) => {
          const option = document.createElement("option");
          option.value = opt;
          option.textContent = opt;
          if (rec.status === opt) option.selected = true;
          statusSelect.appendChild(option);
        });
        statusSelect.addEventListener("change", () => {
          const newStatus = statusSelect.value || "Pendiente";
          updateDoctorRecord(rec.id, { status: newStatus });
        });
        statusField.appendChild(statusLabel);
        statusField.appendChild(statusSelect);

        controls.appendChild(notesField);
        controls.appendChild(statusField);
        item.appendChild(controls);

        container.appendChild(item);
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      console.log("âœ… DOM listo, iniciando app Reclutador MÃ©dicos");

      (async () => {
        loadContactsFromStorage();
        await loadContactsFromFirestoreAndMerge();
        setDefaultInvitationTemplate();
        renderContactedPanel();

        const searchForm = document.getElementById("searchForm");
        const searchButton = document.getElementById("searchButton");
        const exportCsvBtn = document.getElementById("exportCsvBtn");
        const generateMsgBtn = document.getElementById("generateMessageBtn");
        const copyInvitationBtn = document.getElementById("copyInvitationBtn");

        async function handleSearch() {
          const specialty = document.getElementById("specialtyInput").value;
          const location = document.getElementById("locationInput").value;
          const institutionType = document.getElementById("institutionTypeSelect").value;

          console.log("ðŸ” Buscando con filtros:", { specialty, location, institutionType });

          selectedDoctorIds.clear();
          updateSelectionPanelUI();
          showStatusMessage("Buscando mÃ©dicos...");

          searchButton.disabled = true;
          try {
            const results = await searchDoctors({ specialty, location, institutionType });
            currentResults = results.map((doc) => {
              if (!doc.id) doc.id = buildDoctorId(doc);
              ensureDoctorRecord(doc);
              return doc;
            });
            renderResults();
            if (!results.length) {
              // ya mostramos 
::contentReference[oaicite:0]{index=0}
mensaje
            } else {
              showStatusMessage("");
            }
          } finally {
            searchButton.disabled = false;
          }
        }

        searchButton.addEventListener("click", (e) => {
          e.preventDefault();
          handleSearch();
        });

        searchForm.addEventListener("submit", (e) => {
          e.preventDefault();
          handleSearch();
        });

        exportCsvBtn.addEventListener("click", () => exportSelectedToCsv());
        generateMsgBtn.addEventListener("click", () => generateInvitationMessage());
        copyInvitationBtn.addEventListener("click", () => copyInvitationToClipboard());

        const results = await searchDoctors({ specialty: "", location: "", institutionType: "" });
        currentResults = results.map((doc) => {
          if (!doc.id) doc.id = buildDoctorId(doc);
          ensureDoctorRecord(doc);
          return doc;
        });
        renderResults();
      })();
    });
  </script>
</body>
</html>
